
"use strict";

(function() {
    // Check if running in browser environment
    if (typeof window === "undefined") {
        console.log("Not in a window environment");
        return;
    }

    const currentScript = document.currentScript;
    const domain = currentScript?.getAttribute("data-domain");
    const siteId = currentScript?.getAttribute("data-site-id");

    if (!domain && !siteId) return;

    const API_ENDPOINT = "https://pixel-theta-ten.vercel.app/api/collect";

    // Generate unique IDs
    const generateId = () => {
        const timestamp = Date.now().toString(36);
        const random = Math.random().toString(36).substring(2, 15);
        return `${timestamp}-${random}`;
    };

    const VISITOR_ID_KEY = "_px_vid";
    const SESSION_ID_KEY = "_px_sid";

    let visitorId, sessionId;

    try {
        visitorId = localStorage.getItem(VISITOR_ID_KEY) || generateId();
        localStorage.setItem(VISITOR_ID_KEY, visitorId);
        sessionId = sessionStorage.getItem(SESSION_ID_KEY) || generateId();
        sessionStorage.setItem(SESSION_ID_KEY, sessionId);
    } catch {
        visitorId = generateId();
        sessionId = generateId();
    }

    let pageStartTime = performance.now();
    let totalActiveTime = 0;
    let heartbeatInterval = null;

    // Parse UTM parameters
    const urlParams = new URLSearchParams(location.search);
    const utmSource = urlParams.get("utm_source");
    const utmCampaign = urlParams.get("utm_campaign");

    // Build event payload
    const buildPayload = (eventType, additionalData = {}) =>
        JSON.stringify({
            type: eventType,
            domain,
            siteId,
            visitorId,
            sessionId,
            url: location.href,
            referrer: document.referrer || null,
            screenWidth: screen.width,
            userAgent: navigator.userAgent,
            utm_campaign: utmCampaign,
            utm_source: utmSource,
            timestamp: Date.now(),
            ...additionalData,
        });

    // Send event to API
    const sendEvent = (eventType, additionalData) => {
        fetch(API_ENDPOINT, {
            method: "POST",
            body: buildPayload(eventType, additionalData),
            headers: { "Content-Type": "application/json" },
            keepalive: true,
        }).catch(() => {});
    };

    // Handle page exit
    const handlePageExit = () => {
        totalActiveTime += performance.now() - pageStartTime;
        sendEvent("page_exit", { active_time: Math.round(totalActiveTime) });
    };

    // Start heartbeat
    const startHeartbeat = () => {
        if (!heartbeatInterval) {
            heartbeatInterval = setInterval(() => sendEvent("heartbeat"), 10000);
        }
    };

    // Stop heartbeat
    const stopHeartbeat = () => {
        if (heartbeatInterval) {
            clearInterval(heartbeatInterval);
            heartbeatInterval = null;
        }
    };

    // Initial page view
    sendEvent("page_view");
    startHeartbeat();

    // Handle visibility changes
    document.addEventListener("visibilitychange", () => {
        if (document.visibilityState === "hidden") {
            totalActiveTime += performance.now() - pageStartTime;
            stopHeartbeat();
        } else {
            pageStartTime = performance.now();
            startHeartbeat();
        }
    });

    // Handle page unload
    window.addEventListener("pagehide", handlePageExit);
})();